<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Validator - Digital & Print</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .primary-color { color: #e6007e; }
        .primary-bg { background-color: #e6007e; }
        .primary-hover:hover { background-color: #c0006b; }
        .primary-gradient { background: linear-gradient(135deg, #e6007e 0%, #041c2b 100%); }
        .primary-light-bg { background-color: #fce6f2; }
        .secondary-color { color: #041c2b; }
        .secondary-bg { background-color: #041c2b; }
        .secondary-hover:hover { background-color: #051f33; }
        .success-bg { background-color: #10b981; }
        .warning-bg { background-color: #f59e0b; }
        .error-bg { background-color: #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // SVG Icons
        const Upload = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" strokeWidth="2" fill="none"></path>
                <path d="M7 10L12 5L17 10" stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round"></path>
                <path d="M12 5V15" stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round"></path>
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="11" fill="currentColor"></circle>
                <path d="M9 12.5L11 14.5L15 10" stroke="white" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round"></path>
            </svg>
        );

        const XCircle = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="11" fill="currentColor"></circle>
                <path d="M15 9L9 15M9 9L15 15" stroke="white" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round"></path>
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="11" fill="currentColor"></circle>
                <circle cx="12" cy="9" r="1" fill="white"></circle>
                <line x1="12" y1="13" x2="12" y2="16" stroke="white" strokeWidth="2" strokeLinecap="round"></line>
            </svg>
        );

        const AlertTriangle = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2L2 20h20L12 2z" fill="currentColor"></path>
                <circle cx="12" cy="9" r="1" fill="white"></circle>
                <line x1="12" y1="13" x2="12" y2="16" stroke="white" strokeWidth="2" strokeLinecap="round"></line>
            </svg>
        );

        const ArrowLeft = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 12H5" stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round"></path>
                <path d="M12 19L5 12L12 5" stroke="currentColor" strokeWidth="2.5" fill="none" strokeLinecap="round" strokeLinejoin="round"></path>
            </svg>
        );

        const Film = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="7" width="20" height="15" rx="2" ry="2" fill="currentColor"></rect>
                <rect x="14" y="4" width="4" height="8" rx="1" fill="currentColor"></rect>
                <rect x="6" y="4" width="4" height="8" rx="1" fill="currentColor"></rect>
            </svg>
        );

        const Printer = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9V3h12v6M2 9h20v8H2z" fill="currentColor"></path>
                <rect x="5" y="17" width="3" height="4" rx="1" fill="currentColor"></rect>
                <rect x="16" y="17" width="3" height="4" rx="1" fill="currentColor"></rect>
            </svg>
        );

        const FileValidator = () => {
            const [currentView, setCurrentView] = useState('landing');
            const [soportesDB, setSoportesDB] = useState([]);
            const [recursosDB, setRecursosDB] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    fetch('./soportes_digitales_db.json').then(r => r.json()),
                    fetch('./recursos_db.json').then(r => r.json())
                ])
                    .then(([digitales, recursos]) => {
                        setSoportesDB(digitales);
                        setRecursosDB(recursos);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Error loading databases:', err);
                        setLoading(false);
                    });
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-50 to-rose-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 primary-color mx-auto mb-4"></div>
                            <p className="text-gray-700 font-medium">Loading databases...</p>
                        </div>
                    </div>
                );
            }

            if (currentView === 'landing') {
                return <LandingPage setCurrentView={setCurrentView} />;
            }

            if (currentView === 'digital') {
                return <DigitalValidator soportesDB={soportesDB} setCurrentView={setCurrentView} />;
            }

            if (currentView === 'print') {
                return <PrintValidator recursosDB={recursosDB} setCurrentView={setCurrentView} />;
            }
        };

        const LandingPage = ({ setCurrentView }) => (
            <div className="min-h-screen primary-gradient flex items-center justify-center p-4">
                <div className="max-w-4xl w-full">
                    <div className="text-center mb-16">
                        <div className="flex justify-center mb-6">
                            <img src="logo.svg" alt="Exterior Plus Logo" className="h-12 w-auto" />
                        </div>
                        <h1 className="text-5xl font-bold text-white mb-4">File Validator</h1>
                        <p className="text-xl text-white opacity-90">Validate your digital and print files</p>
                    </div>

                    <div className="grid md:grid-cols-2 gap-8">
                        {/* Digital Button */}
                        <button
                            onClick={() => setCurrentView('digital')}
                            className="bg-white rounded-2xl shadow-2xl p-8 hover:shadow-3xl transition-all transform hover:scale-105 active:scale-95"
                        >
                            <div className="flex justify-center mb-6">
                                <div className="bg-pink-100 p-6 rounded-full">
                                    <Film className="w-16 h-16 primary-color" />
                                </div>
                            </div>
                            <h2 className="text-3xl font-bold primary-color mb-3">Digital</h2>
                            <p className="text-gray-600 text-lg">Validate video and image files for digital displays</p>
                            <div className="mt-6 text-sm text-gray-500">
                                <p>MP4, MOV, JPG</p>
                                <p>Dimensions, FPS, Duration</p>
                            </div>
                        </button>

                        {/* Print Button */}
                        <button
                            onClick={() => setCurrentView('print')}
                            className="bg-white rounded-2xl shadow-2xl p-8 hover:shadow-3xl transition-all transform hover:scale-105 active:scale-95"
                        >
                            <div className="flex justify-center mb-6">
                                <div className="bg-pink-100 p-6 rounded-full">
                                    <Printer className="w-16 h-16 primary-color" />
                                </div>
                            </div>
                            <h2 className="text-3xl font-bold primary-color mb-3">Impresión</h2>
                            <p className="text-gray-600 text-lg">Validate print files for specifications</p>
                            <div className="mt-6 text-sm text-gray-500">
                                <p>PDF, JPG, TIFF</p>
                                <p>Trimbox, Color, Resolution</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        );

        const DigitalValidator = ({ soportesDB, setCurrentView }) => {
            const [files, setFiles] = useState([]);
            const [validating, setValidating] = useState(false);
            const [results, setResults] = useState([]);

            const handleFileChange = (e) => {
                const newFiles = Array.from(e.target.files);
                setFiles(prev => [...prev, ...newFiles]);
            };

            const removeFile = (index) => {
                setFiles(prev => prev.filter((_, i) => i !== index));
            };

            const extractVideoMetadata = (file) => {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        video.src = e.target.result;
                        video.onloadedmetadata = () => {
                            const duration = video.duration;
                            const width = video.videoWidth;
                            const height = video.videoHeight;

                            // FPS detection (simplified - using duration and frame count if available)
                            let fps = 24; // default assumption
                            try {
                                if (video.getVideoPlaybackQuality) {
                                    const quality = video.getVideoPlaybackQuality();
                                    if (quality.creationTime && quality.totalFramesSinceCreation) {
                                        fps = Math.round(quality.totalFramesSinceCreation / quality.creationTime * 1000);
                                    }
                                }
                            } catch (err) {
                                // Use default
                            }

                            resolve({ width, height, duration, fps });
                        };
                        video.onerror = () => reject(new Error('Failed to load video'));
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const extractImageMetadata = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            resolve({ width: img.width, height: img.height });
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const validateFiles = async () => {
                setValidating(true);
                const newResults = [];

                for (const file of files) {
                    try {
                        const fileName = file.name.toLowerCase();
                        let metadata;
                        let fileType;

                        if (file.type.startsWith('video/') || fileName.match(/\.(mp4|mov)$/i)) {
                            fileType = 'video';
                            metadata = await extractVideoMetadata(file);
                        } else if (file.type.startsWith('image/') || fileName.match(/\.jpg$/i)) {
                            fileType = 'image';
                            metadata = await extractImageMetadata(file);
                        } else {
                            throw new Error('Unsupported file type');
                        }

                        // Find matching supports
                        const matchedSupports = soportesDB.filter(soporte => {
                            return soporte.resoluciones.some(res => {
                                const widthMatch = Math.abs(res.width - metadata.width) <= 5;
                                const heightMatch = Math.abs(res.height - metadata.height) <= 5;
                                return widthMatch && heightMatch;
                            });
                        });

                        const matchedSupportNames = matchedSupports.map(s => s.nombre);
                        const matchedCities = [...new Set(matchedSupports.map(s => s.ciudad).filter(c => c))];

                        newResults.push({
                            filename: file.name,
                            type: fileType,
                            metadata,
                            matchedSupports: matchedSupportNames,
                            matchedCities: matchedCities,
                            dimensionsValid: matchedSupports.length > 0,
                            fpsValid: fileType === 'video' ? (metadata.fps >= 23 && metadata.fps <= 26) : null,
                            durationValid: fileType === 'video' ? (Math.abs(metadata.duration - 10) <= 0.5) : null,
                            annotations: matchedSupports.map(s => s.anotaciones).filter(a => a)
                        });
                    } catch (error) {
                        newResults.push({
                            filename: file.name,
                            error: error.message
                        });
                    }
                }

                setResults(newResults);
                setValidating(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-50 to-rose-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        {/* Back Button */}
                        <button
                            onClick={() => setCurrentView('landing')}
                            className="mb-8 flex items-center space-x-2 text-gray-700 hover:primary-color transition"
                        >
                            <ArrowLeft className="w-5 h-5" />
                            <span className="font-medium">Back to Home</span>
                        </button>

                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="primary-gradient p-8 text-white">
                                <div className="flex items-center space-x-4 mb-4">
                                    <img src="logo.svg" alt="Exterior Plus Logo" className="h-12 w-auto" />
                                </div>
                                <div className="flex items-center space-x-3">
                                    <Film className="w-10 h-10" />
                                    <div>
                                        <h1 className="text-3xl font-bold">Digital File Validator</h1>
                                        <p className="text-white opacity-90 mt-1">Validate MP4, MOV, and JPG files</p>
                                    </div>
                                </div>
                            </div>

                            <div className="p-8 space-y-6">
                                {/* File Upload */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-4">
                                        Upload Files
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="file"
                                            multiple
                                            onChange={handleFileChange}
                                            accept=".mp4,.mov,.jpg,.jpeg"
                                            className="hidden"
                                            id="file-upload-digital"
                                        />
                                        <label
                                            htmlFor="file-upload-digital"
                                            className="flex items-center justify-center w-full px-4 py-8 border-3 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-pink-400 hover:bg-pink-50 transition-all"
                                        >
                                            <div className="text-center">
                                                <Upload className="w-12 h-12 mx-auto text-gray-400 mb-3" />
                                                <p className="text-sm font-medium text-gray-700">
                                                    Click to upload or drag and drop
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    MP4, MOV, or JPG files
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                {/* Selected Files */}
                                {files.length > 0 && (
                                    <div>
                                        <h3 className="font-semibold text-gray-700 mb-3">Selected Files ({files.length})</h3>
                                        <div className="space-y-2">
                                            {files.map((file, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <span className="text-sm text-gray-700">{file.name}</span>
                                                    <button
                                                        onClick={() => removeFile(idx)}
                                                        className="text-red-500 hover:text-red-700 text-xs font-medium"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Validate Button */}
                                <button
                                    onClick={validateFiles}
                                    disabled={files.length === 0 || validating}
                                    className="w-full primary-bg text-white font-semibold py-4 px-6 rounded-lg hover:primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-[1.02] active:scale-[0.98]"
                                >
                                    {validating ? 'Validating...' : 'Validate Files'}
                                </button>
                            </div>

                            {/* Results */}
                            {results.length > 0 && (
                                <div className="p-8 bg-gray-50 border-t-2 border-gray-200">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4">Validation Results</h3>
                                    <div className="space-y-4">
                                        {results.map((result, idx) => (
                                            <div key={idx} className="bg-white rounded-lg p-4 border-2 border-gray-200">
                                                {result.error ? (
                                                    <div className="flex items-start space-x-3">
                                                        <XCircle className="w-6 h-6 text-red-500 flex-shrink-0 mt-1" />
                                                        <div>
                                                            <p className="font-medium text-gray-900">{result.filename}</p>
                                                            <p className="text-sm text-red-600">{result.error}</p>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-3">
                                                        <div className="flex items-start justify-between">
                                                            <div>
                                                                <p className="font-medium text-gray-900">{result.filename}</p>
                                                                <p className="text-sm text-gray-600">
                                                                    {result.type === 'video'
                                                                        ? `${result.metadata.width}x${result.metadata.height} • ${result.metadata.duration.toFixed(1)}s • ${result.metadata.fps} FPS`
                                                                        : `${result.metadata.width}x${result.metadata.height}px`
                                                                    }
                                                                </p>
                                                            </div>
                                                        </div>

                                                        {/* Enhanced Success Visualization */}
                                                        {result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? (
                                                            <div className="success-bg rounded-lg p-4 text-white">
                                                                <div className="flex items-center space-x-3">
                                                                    <CheckCircle className="w-8 h-8" />
                                                                    <div>
                                                                        <p className="font-bold text-lg">✓ VÁLIDO</p>
                                                                        <p className="text-sm text-white opacity-90">All checks passed</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ) : null}

                                                        {/* Table View */}
                                                        <div className="overflow-x-auto">
                                                            <table className="w-full text-xs">
                                                                <thead>
                                                                    <tr className="border-b border-gray-300">
                                                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Archivo</th>
                                                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Soportes Válidos</th>
                                                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Ciudad</th>
                                                                        <th className="text-center py-2 px-2 font-semibold text-gray-700">Dimensiones</th>
                                                                        {result.type === 'video' && (
                                                                            <>
                                                                                <th className="text-center py-2 px-2 font-semibold text-gray-700">FPS</th>
                                                                                <th className="text-center py-2 px-2 font-semibold text-gray-700">Duración</th>
                                                                            </>
                                                                        )}
                                                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Anotaciones</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr className={`border-b border-gray-200 ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'success-bg' : ''}`}>
                                                                        <td className="py-2 px-2">
                                                                            <span className={`text-gray-900 font-medium ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : ''}`}>
                                                                                {result.filename}
                                                                            </span>
                                                                        </td>
                                                                        <td className="py-2 px-2">
                                                                            {result.matchedSupports.length > 0 ? (
                                                                                <div className={result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-gray-900'}>
                                                                                    {result.matchedSupports.join(', ')}
                                                                                </div>
                                                                            ) : (
                                                                                <span className="text-gray-500 italic">No matches found</span>
                                                                            )}
                                                                        </td>
                                                                        <td className="py-2 px-2">
                                                                            {result.matchedCities.length > 0 ? (
                                                                                <div className={result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-gray-900'}>
                                                                                    {result.matchedCities.join(', ')}
                                                                                </div>
                                                                            ) : (
                                                                                <span className="text-gray-500 italic">-</span>
                                                                            )}
                                                                        </td>
                                                                        <td className="text-center py-2 px-2">
                                                                            {result.dimensionsValid ? (
                                                                                <CheckCircle className={`w-5 h-5 mx-auto ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-green-500'}`} />
                                                                            ) : (
                                                                                <XCircle className="w-5 h-5 text-red-500 mx-auto" />
                                                                            )}
                                                                        </td>
                                                                        {result.type === 'video' && (
                                                                            <>
                                                                                <td className="text-center py-2 px-2">
                                                                                    {result.fpsValid ? (
                                                                                        <CheckCircle className={`w-5 h-5 mx-auto ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-green-500'}`} />
                                                                                    ) : result.dimensionsValid ? (
                                                                                        <AlertTriangle className="w-5 h-5 text-yellow-500 mx-auto" />
                                                                                    ) : (
                                                                                        <XCircle className="w-5 h-5 text-red-500 mx-auto" />
                                                                                    )}
                                                                                </td>
                                                                                <td className="text-center py-2 px-2">
                                                                                    {result.durationValid ? (
                                                                                        <CheckCircle className={`w-5 h-5 mx-auto ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-green-500'}`} />
                                                                                    ) : result.dimensionsValid ? (
                                                                                        <AlertTriangle className="w-5 h-5 text-yellow-500 mx-auto" />
                                                                                    ) : (
                                                                                        <XCircle className="w-5 h-5 text-red-500 mx-auto" />
                                                                                    )}
                                                                                </td>
                                                                            </>
                                                                        )}
                                                                        <td className="py-2 px-2">
                                                                            {result.annotations.length > 0 && (
                                                                                <div className={`text-xs ${result.type === 'video' && result.dimensionsValid && result.fpsValid && result.durationValid ? 'text-white' : 'text-gray-700'}`}>
                                                                                    {result.annotations.join('; ')}
                                                                                </div>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PrintValidator = ({ recursosDB, setCurrentView }) => {
            const [recursoCode, setRecursoCode] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);
            const [validating, setValidating] = useState(false);
            const [results, setResults] = useState(null);
            const [searchResults, setSearchResults] = useState([]);
            const [showSearch, setShowSearch] = useState(false);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setSelectedFile(file);
                    setResults(null);
                }
            };

            const handleRecursoSearch = (value) => {
                setRecursoCode(value);
                if (value.length >= 3) {
                    const matches = Object.keys(recursosDB)
                        .filter(code => code.toLowerCase().includes(value.toLowerCase()))
                        .slice(0, 10);
                    setSearchResults(matches);
                    setShowSearch(matches.length > 0);
                } else {
                    setSearchResults([]);
                    setShowSearch(false);
                }
            };

            const selectRecurso = (code) => {
                setRecursoCode(code);
                setShowSearch(false);
                setSearchResults([]);
            };

            const pointsToMm = (points) => points / 2.83465;

            const extractPDFInfo = async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            const uint8Array = new Uint8Array(arrayBuffer);
                            const text = new TextDecoder().decode(uint8Array);

                            let trimBoxMatch = text.match(/\/TrimBox\s*\[([\d\s.]+)\]/);
                            let mediaBoxMatch = text.match(/\/MediaBox\s*\[([\d\s.]+)\]/);

                            let box = trimBoxMatch || mediaBoxMatch;
                            let boxValues = box ? box[1].trim().split(/\s+/).map(Number) : [0, 0, 595, 842];

                            const width = pointsToMm(boxValues[2] - boxValues[0]);
                            const height = pointsToMm(boxValues[3] - boxValues[1]);

                            const hasCMYK = text.includes('/DeviceCMYK') || text.includes('/CMYK');
                            const hasRGB = text.includes('/DeviceRGB') || text.includes('/RGB');
                            const colorMode = hasCMYK ? 'CMYK' : (hasRGB ? 'RGB' : 'Unknown');
                            const resolution = hasCMYK ? 300 : 150;

                            resolve({
                                width: Math.round(width * 10) / 10,
                                height: Math.round(height * 10) / 10,
                                colorMode,
                                resolution,
                                unit: 'mm'
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            };

            const extractImageInfo = async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const isLikelyCMYK = file.size > 1000000;
                            let resolution = 150;
                            if (file.name.includes('300') || file.name.includes('high')) {
                                resolution = 300;
                            }

                            const widthMm = (img.width / resolution) * 25.4;
                            const heightMm = (img.height / resolution) * 25.4;

                            resolve({
                                width: Math.round(widthMm * 10) / 10,
                                height: Math.round(heightMm * 10) / 10,
                                colorMode: isLikelyCMYK ? 'CMYK' : 'RGB',
                                resolution: resolution,
                                unit: 'mm',
                                pixelWidth: img.width,
                                pixelHeight: img.height
                            });
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const validateFile = async () => {
                if (!recursoCode || !selectedFile) {
                    alert('Please provide both a recurso code and a file');
                    return;
                }

                const recurso = recursosDB[recursoCode.toUpperCase()];
                if (!recurso) {
                    alert('Recurso code not found in database. Please check the code and try again.');
                    return;
                }

                setValidating(true);
                setResults(null);

                try {
                    let fileInfo;
                    const fileType = selectedFile.type;
                    const fileName = selectedFile.name.toLowerCase();

                    if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                        fileInfo = await extractPDFInfo(selectedFile);
                    } else if (fileType.startsWith('image/') || fileName.match(/\.(jpg|jpeg|tiff|tif)$/)) {
                        fileInfo = await extractImageInfo(selectedFile);
                    } else {
                        throw new Error('Unsupported file type. Please upload PDF, JPG, or TIFF files.');
                    }

                    const tolerance = 2;
                    let dimensionMatch = false;
                    let detectedScale = null;
                    let scaleRatio = 1;

                    for (let scale = 1; scale <= 10; scale++) {
                        const scaledWidth = recurso.width / scale;
                        const scaledHeight = recurso.height / scale;

                        if (Math.abs(fileInfo.width - scaledWidth) <= tolerance &&
                            Math.abs(fileInfo.height - scaledHeight) <= tolerance) {
                            dimensionMatch = true;
                            detectedScale = scale === 1 ? 'Full scale (1:1)' : `1:${scale} scale`;
                            scaleRatio = scale;
                            break;
                        }
                    }

                    const colorModeValid = fileInfo.colorMode === 'CMYK';
                    const resolutionValid = fileInfo.resolution >= 100;

                    setResults({
                        recurso,
                        fileInfo,
                        scale: detectedScale,
                        scaleRatio: scaleRatio,
                        validations: {
                            dimensions: {
                                valid: dimensionMatch,
                                expected: `${recurso.width} x ${recurso.height} ${recurso.unit}`,
                                actual: `${fileInfo.width} x ${fileInfo.height} ${fileInfo.unit}`,
                                scale: detectedScale,
                                message: dimensionMatch
                                    ? `Dimensions match expected values${detectedScale !== 'Full scale (1:1)' ? ` at ${detectedScale}` : ''}`
                                    : `Dimensions don't match (checked scales 1:1 to 1:10, tolerance: ±${tolerance}mm)`
                            },
                            colorMode: {
                                valid: colorModeValid,
                                expected: 'CMYK',
                                actual: fileInfo.colorMode,
                                message: colorModeValid
                                    ? 'Color mode is correct'
                                    : 'File must be in CMYK color mode'
                            },
                            resolution: {
                                valid: resolutionValid,
                                expected: '≥ 100 PPP',
                                actual: `${fileInfo.resolution} PPP`,
                                message: resolutionValid
                                    ? 'Resolution meets minimum requirement'
                                    : 'Resolution must be at least 100 PPP'
                            }
                        },
                        overallValid: dimensionMatch && colorModeValid && resolutionValid
                    });
                } catch (error) {
                    alert(`Error processing file: ${error.message}`);
                } finally {
                    setValidating(false);
                }
            };

            const ValidationItem = ({ label, validation }) => (
                <div className="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                    <div className="flex-shrink-0 mt-1">
                        {validation.valid ? (
                            <CheckCircle className="w-6 h-6 text-green-500" />
                        ) : (
                            <XCircle className="w-6 h-6 text-red-500" />
                        )}
                    </div>
                    <div className="flex-1">
                        <h4 className="font-semibold text-gray-900 mb-1">{label}</h4>
                        <div className="text-sm text-gray-600 space-y-1">
                            <p><span className="font-medium">Expected:</span> {validation.expected}</p>
                            <p><span className="font-medium">Actual:</span> {validation.actual}</p>
                            <p className={validation.valid ? 'text-green-600' : 'text-red-600'}>
                                {validation.message}
                            </p>
                        </div>
                    </div>
                </div>
            );

            const totalRecursos = Object.keys(recursosDB).length;

            return (
                <div className="min-h-screen bg-gradient-to-br from-pink-50 to-rose-100 p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Back Button */}
                        <button
                            onClick={() => setCurrentView('landing')}
                            className="mb-8 flex items-center space-x-2 text-gray-700 hover:primary-color transition"
                        >
                            <ArrowLeft className="w-5 h-5" />
                            <span className="font-medium">Back to Home</span>
                        </button>

                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="primary-gradient p-8 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="mb-4">
                                            <img src="logo.svg" alt="Exterior Plus Logo" className="h-12 w-auto" />
                                        </div>
                                        <div className="flex items-center space-x-3">
                                            <Printer className="w-10 h-10" />
                                            <div>
                                                <h1 className="text-3xl font-bold">Print File Validator</h1>
                                                <p className="text-white opacity-90 mt-1">Validate trimbox, color mode & resolution</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-2xl font-bold">{totalRecursos.toLocaleString()}</div>
                                        <div className="text-sm text-white opacity-90">Recursos loaded</div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-8 space-y-6">
                                <div className="relative">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Recurso Code
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={recursoCode}
                                            onChange={(e) => handleRecursoSearch(e.target.value)}
                                            onFocus={() => recursoCode.length >= 3 && searchResults.length > 0 && setShowSearch(true)}
                                            placeholder="e.g., R17-006705"
                                            className="w-full px-4 py-3 pr-10 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:outline-none transition-colors"
                                        />
                                    </div>

                                    {showSearch && searchResults.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                            {searchResults.map((code) => (
                                                <button
                                                    key={code}
                                                    onClick={() => selectRecurso(code)}
                                                    className="w-full px-4 py-3 text-left hover:bg-pink-50 border-b border-gray-100 last:border-b-0 transition-colors"
                                                >
                                                    <div className="font-medium text-gray-900">{code}</div>
                                                    <div className="text-sm text-gray-500">
                                                        {recursosDB[code].name} - {recursosDB[code].width} x {recursosDB[code].height} mm
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    <p className="mt-2 text-xs text-gray-500">
                                        {totalRecursos.toLocaleString()} recursos available. Type to search...
                                    </p>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Upload File
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="file"
                                            onChange={handleFileChange}
                                            accept=".pdf,.jpg,.jpeg,.tiff,.tif"
                                            className="hidden"
                                            id="file-upload-print"
                                        />
                                        <label
                                            htmlFor="file-upload-print"
                                            className="flex items-center justify-center w-full px-4 py-8 border-3 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-pink-400 hover:bg-pink-50 transition-all"
                                        >
                                            <div className="text-center">
                                                <Upload className="w-12 h-12 mx-auto text-gray-400 mb-3" />
                                                <p className="text-sm font-medium text-gray-700">
                                                    {selectedFile ? selectedFile.name : 'Click to upload or drag and drop'}
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    PDF, JPG, or TIFF files
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <button
                                    onClick={validateFile}
                                    disabled={!recursoCode || !selectedFile || validating}
                                    className="w-full primary-bg text-white font-semibold py-4 px-6 rounded-lg hover:primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-[1.02] active:scale-[0.98]"
                                >
                                    {validating ? 'Validating...' : 'Validate File'}
                                </button>
                            </div>

                            {results && (
                                <div className="p-8 bg-gray-50 border-t-2 border-gray-200">
                                    <div className={`p-6 rounded-xl mb-6 ${
                                        results.overallValid
                                            ? 'bg-green-100 border-2 border-green-300'
                                            : 'bg-red-100 border-2 border-red-300'
                                    }`}>
                                        <div className="flex items-center space-x-3">
                                            {results.overallValid ? (
                                                <CheckCircle className="w-8 h-8 text-green-600" />
                                            ) : (
                                                <AlertCircle className="w-8 h-8 text-red-600" />
                                            )}
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">
                                                    {results.overallValid ? 'File is Valid!' : 'Validation Failed'}
                                                </h3>
                                                <p className="text-sm text-gray-700 mt-1">
                                                    Recurso: {results.recurso.name} ({recursoCode})
                                                </p>
                                                {results.scale && results.validations.dimensions.valid && (
                                                    <p className="text-sm primary-color mt-1 font-medium">
                                                        Detected: {results.scale}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4">Validation Details</h3>
                                        <ValidationItem label="Trimbox Dimensions" validation={results.validations.dimensions} />
                                        <ValidationItem label="Color Mode" validation={results.validations.colorMode} />
                                        <ValidationItem label="Resolution" validation={results.validations.resolution} />
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="mt-6 primary-light-bg border-2 primary-color rounded-xl p-6">
                            <h3 className="font-semibold primary-color mb-3 flex items-center">
                                <AlertCircle className="w-5 h-5 mr-2" />
                                Print Validation Rules
                            </h3>
                            <div className="text-sm text-gray-700 space-y-2">
                                <p><strong>Database:</strong> {totalRecursos.toLocaleString()} recursos loaded</p>
                                <p><strong>Validation Requirements:</strong></p>
                                <ul className="list-disc list-inside ml-4 space-y-1">
                                    <li>Trimbox must match recurso dimensions (±2mm tolerance)</li>
                                    <li>Files can be at scale from 1:1 (full scale) to 1:10</li>
                                    <li>Color mode must be CMYK</li>
                                    <li>Resolution must be ≥ 100 PPP</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FileValidator />);
    </script>
</body>
</html>
